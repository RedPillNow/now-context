<link rel="import" href="../../paper-item/paper-item.html">
<dom-module id="now-context-test">
	<template>
		<style>
			:host {
				display: block;
				box-sizing: border-box;
				font-family: 'Roboto', 'Helvetica Neue', Helvetica, Arial, sans-serif;
				font-size: 14px;
				line-height: 1.5;
			}
			paper-item:first-child {
				margin-top: 10px;
			}
			paper-item {
				margin-bottom: 10px;
				--paper-item: {
					border: 1px solid #afafaf;
				};
			}
			.label {
				font-size: 12px;
			}
			.value {
				font-size: 13px;
				font-weight: 500;
			}
			.title .value {
				font-size: 14px;
				font-weight: 600;
			}
			.getRequestCount {
				font-size: 12px;
			}
			.note {
				font-style: italic;
				font-weight: 600;
			}
		</style>
		<div class="layout horizontal">
			<button on-click="getNext">Get Next</button>
			<button on-click="getSame" disabled$="{{getSameDisabled}}">Get Same Record Again</button>
			<button on-click="getPosts">Get Posts</button>
			<button id="clearContext" on-click="clearDisplay">Clear Display</button>
			<span class="flex"></span>
			<div class="getRequestCount">
				<span
					title="The number of network requests made. Driven by the now-context PubSub system">
					{{getReqCount}} GET requests have been made
				</span>
			</div>
		</div>
		<div>
			<p>In order to access the context there is a global variable called "NowContext.context". This will be the context object which contains all the responses (that were different).</p>
			<p>If an item does not have an id (for example the response was an array) then the url will be the key, otherwise the id is the key.</p>
			<p class="note">Open the console to see relevant messages</p>
		<div id="contextDisplay">
			<template is="dom-repeat" items="{{contextDisplay}}" as="contextItem">
				<paper-item>
					<div class="layout vertical">
						<div class="layout horizontal title">
							<span class="value">{{contextItem.title}}</span>
						</div>
						<div class="layout horizontal">
							<span class="label">{{contextItem.idKey}}:</span>
							<span class="value">{{contextItem.id}}</span>
						</div>
						<div class="layout horizontal">
							<span class="label">URL:</span>
							<span class="value">{{contextItem.url}}</span>
						</div>
					</div>
				</paper-item>
			</template>
		</div>
	</template>
	<script>
class NowContextTest extends Polymer.Element {
	static get is() { return 'now-context-test' }

	static get properties() {
		return {
			context: {
				type: Object,
				notify: true
			},
			count: {
				type: Number,
				value: 0
			},
			getReqCount: {
				type: Number,
				value: 0
			},
			contextDisplay: {
				type: String,
				notify: true,
				value: []
			},
			getSameDisabled: {
				type: Boolean,
				value: true,
				computed: '_isGetSameDisabled(count)'
			}
		};
	}

	constructor() {
		super();
	}

	connectedCallback() {
		super.connectedCallback();
		setTimeout(() => {
			NowContext.listenEvt('nowContextGetReqDone', this.onContextGetReqDone, this);
			NowContext.listenEvt('nowContextItemUpdated', this.onContextItemUpdated);
			NowContext.listenEvt('nowContextItemAdded', this.onContextItemAdded, this);
		}, 1000);
	}

	_isGetSameDisabled(count) {
		return !(count > 0);
	}

	onContextItemAdded(item) {
		if (item && Object.keys(item).length > 0) {
			let isArray = Array.isArray(item.model);
			let contextDispItem = {
				id: isArray ? item.lastAjaxRequest.requestUrl : item[item.idKey],
				idKey: item.idKey,
				url: item.lastAjaxRequest.requestUrl,
				title: isArray ? 'Array (' + item.model.length + ')' : item.model['title']
			}
			this.push('contextDisplay', contextDispItem);
		}
	}

	getNext(evt, detail) {
		this.count++;
		let url = 'https://jsonplaceholder.typicode.com/posts/' + this.count;
		this._fireEvent(url, 'id', this.count);
	}

	getSame(evt, detail) {
		if (this.count > 0) {
			let url = 'https://jsonplaceholder.typicode.com/posts/' + this.count;
			this._fireEvent(url, 'id', this.count);
		}
	}

	getPosts(evt, detail) {
		let url = 'https://jsonplaceholder.typicode.com/posts';
		this._fireEvent(url, null, url);
	}

	_fireEvent(url, idKey, contextKey) {
		let detailObj = {
			ajax: {
				url: url,
				idKey: idKey,
				method: 'GET'
			}
		};
		if (this.context.hasOwnProperty(contextKey)) {
			console.warn(NowContextTest.is, 'We will do the request, however the display will not be updated because we already have the requested item in the context', this.context[contextKey]);
		}
		NowContext.triggerEvt('nowcontextget', detailObj);
	}

	clearDisplay(evt) {
		this.set('contextDisplay', []);
		this.set('count', 0);
	}

	onContextGetReqDone(data) {
		this.getReqCount++;
	}

	onContextItemUpdated(data) {
		console.log(NowContextTest.is, 'onNowContextContextUpdated, This is the handler for the nowContextItemUpdated pubsub event', data, 'Handler context=', this);
	}
}
customElements.define(NowContextTest.is, NowContextTest);
	</script>
</dom-module>
